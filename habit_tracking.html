<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0"
    />
    <title>Daily Habit Tracker</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Floating add button */
      .add-habit-btn {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        width: 3rem;
        height: 3rem;
        background: #3b82f6;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
        z-index: 50;
      }
      .add-habit-btn:hover {
        transform: scale(1.1);
      }
      /* Modal close button styles */
      .modal-close-btn {
        width: 2rem;
        height: 2rem;
        border-radius: 9999px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f3f4f6;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
        padding: 0;
        color: #6b7280;
      }
      .modal-close-btn:hover {
        background-color: #e5e7eb;
        color: #374151;
        transform: scale(1.05);
      }
      .modal-close-btn:active {
        transform: scale(0.95);
      }
      .modal-close-btn svg {
        width: 1.25rem;
        height: 1.25rem;
      }
      /* Heatmap cell styles */
      .heatmap-cell {
        height: clamp(36px, 10vw, 48px);
        border: 1px solid #e5e7eb;
        cursor: pointer;
        border-radius: 0.375rem;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0.25rem;
        width: 100%;
      }
      .heatmap-cell:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }
      .heatmap-row {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 0.25rem;
      }
      /* Habit entry styles */
      .habit-entry {
        background-color: #f9fafb;
        padding: 1rem;
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb;
        margin-bottom: 1rem;
        position: relative;
      }
      .habit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }
      .habit-title {
        font-size: 1.125rem;
        font-weight: 600;
      }
      .streak-indicator {
        font-size: 0.875rem;
        background-color: #10b981;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 9999px;
      }
      .habit-completed {
        text-decoration: line-through;
        opacity: 0.6;
      }
      /* Toggle switch (for settings) */
      .toggle-switch {
        position: relative;
        display: inline-block;
        width: 3rem;
        height: 1.5rem;
      }
      .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .toggle-switch .slider {
        position: absolute;
        cursor: pointer;
        inset: 0;
        background-color: #e5e7eb;
        transition: 0.3s;
        border-radius: 9999px;
      }
      .toggle-switch .slider:before {
        position: absolute;
        content: "";
        height: 1.25rem;
        width: 1.25rem;
        left: 2px;
        bottom: 2px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
      }
      .toggle-switch input:checked + .slider {
        background-color: #3b82f6;
      }
      .toggle-switch input:checked + .slider:before {
        transform: translateX(1.5rem);
      }
      /* Responsive adjustments */
      @media (max-width: 640px) {
        .habit-header {
          flex-direction: column;
          align-items: flex-start;
        }
        .habit-title {
          margin-bottom: 0.5rem;
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 p-3 sm:p-6 font-sans">
    <!-- Header -->
    <header class="mb-6 flex items-center justify-between">
      <h1 class="text-2xl font-bold">Daily Habit Tracker</h1>
      <button id="settings-btn" class="w-10 h-10 flex items-center justify-center border border-gray-200 bg-white rounded-full shadow hover:bg-gray-50 transition">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          class="h-6 w-6"
          fill="none"
          viewBox="0 0 24 24"
          stroke="currentColor"
        >
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M11.049 2.927c.3-.921 1.603-.921 1.902 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c.921.3.921 1.603 0 1.902a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.3.921-1.603.921-1.902 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-.921-.3-.921-1.603 0-1.902a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
          />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
          />
        </svg>
      </button>
    </header>

    <!-- Main Content -->
    <main class="grid gap-3 sm:gap-6">
      <!-- Streaks Visualization Section -->
      <section id="streaks-visualization" class="bg-white p-3 sm:p-4 rounded shadow">
        <div id="heatmap-container"></div>
      </section>

      <!-- Habit List Section -->
      <section id="habit-list" class="bg-white p-3 sm:p-4 rounded shadow">
        <h2 class="text-xl font-semibold mb-3 sm:mb-4">My Habits</h2>
        <div id="habit-entries"></div>
      </section>

      <!-- Data Management -->
      <section id="data-management" class="bg-white p-3 sm:p-4 rounded shadow">
        <h2 class="text-xl font-semibold mb-3 sm:mb-4">Data Management</h2>
        <div class="flex items-center gap-2 sm:gap-3">
          <button id="export-data" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-700 transition text-sm">
            Export Data
          </button>
          <input type="file" id="import-data" accept=".json" class="hidden" />
          <button id="import-data-btn" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-700 transition text-sm">
            Import Data
          </button>
        </div>
      </section>
    </main>

    <!-- Floating Add Habit Button -->
    <button id="add-habit-btn" class="add-habit-btn">+</button>

    <!-- Add Habit Modal -->
    <div id="add-habit-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-50">
      <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">Add New Habit</h2>
          <button type="button" class="modal-close modal-close-btn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <form id="add-habit-form" class="space-y-4">
          <div>
            <label for="habit-name" class="block text-sm font-medium text-gray-700">Habit Name</label>
            <input type="text" id="habit-name" required class="mt-1 p-2 w-full border rounded focus:ring-blue-500 focus:border-blue-500" />
          </div>
          <div>
            <label for="habit-desc" class="block text-sm font-medium text-gray-700">Description (optional)</label>
            <textarea id="habit-desc" class="mt-1 p-2 w-full border rounded focus:ring-blue-500 focus:border-blue-500" rows="2"></textarea>
          </div>
          <div>
            <label for="habit-type" class="block text-sm font-medium text-gray-700">Type</label>
            <select id="habit-type" class="mt-1 p-2 w-full border rounded focus:ring-blue-500 focus:border-blue-500">
              <option value="good">Good Habit</option>
              <option value="bad">Bad Habit</option>
            </select>
          </div>
          <button type="submit" class="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-700 focus:outline-none">
            Add Habit
          </button>
        </form>
      </div>
    </div>

    <!-- Edit Habit Modal -->
    <div id="edit-habit-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-50">
      <div class="bg-white p-6 rounded-lg shadow-xl max-w-md w-full">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">Edit Habit</h2>
          <button type="button" class="modal-close modal-close-btn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <form id="edit-habit-form" class="space-y-4">
          <input type="hidden" id="edit-habit-id" />
          <div>
            <label for="edit-habit-name" class="block text-sm font-medium text-gray-700">Habit Name</label>
            <input type="text" id="edit-habit-name" required class="mt-1 p-2 w-full border rounded focus:ring-blue-500 focus:border-blue-500" />
          </div>
          <div>
            <label for="edit-habit-desc" class="block text-sm font-medium text-gray-700">Description (optional)</label>
            <textarea id="edit-habit-desc" class="mt-1 p-2 w-full border rounded focus:ring-blue-500 focus:border-blue-500" rows="2"></textarea>
          </div>
          <div>
            <label for="edit-habit-type" class="block text-sm font-medium text-gray-700">Type</label>
            <select id="edit-habit-type" class="mt-1 p-2 w-full border rounded focus:ring-blue-500 focus:border-blue-500">
              <option value="good">Good Habit</option>
              <option value="bad">Bad Habit</option>
            </select>
          </div>
          <div class="flex justify-between">
            <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-700 focus:outline-none">
              Save Changes
            </button>
            <button type="button" id="delete-habit-btn" class="bg-red-500 text-white py-2 px-4 rounded hover:bg-red-700 focus:outline-none">
              Delete
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-50">
      <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-lg font-semibold">Settings</h2>
          <button type="button" class="modal-close modal-close-btn">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        <div class="space-y-4">
          <div class="flex items-center justify-between">
            <label for="hide-completed-habits" class="text-sm text-gray-700">Hide Completed Habits</label>
            <label class="toggle-switch">
              <input type="checkbox" id="hide-completed-habits" />
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Helper functions
      const $ = (id) => document.getElementById(id);
      const formatDate = (date) => {
        const d = new Date(date);
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      };

      // Habit class to store habit data and compute streaks
      class Habit {
        constructor(data) {
          this.id = data.id || Date.now().toString();
          this.name = data.name;
          this.description = data.description || "";
          this.type = data.type || "good"; // "good" or "bad"
          // history is an array of date strings (YYYY-MM-DD) when habit was completed
          this.history = data.history || [];
        }

        markCompleted(dateStr) {
          if (!this.history.includes(dateStr)) {
            this.history.push(dateStr);
            this.history.sort();
          }
        }

        unmarkCompleted(dateStr) {
          this.history = this.history.filter((d) => d !== dateStr);
        }

        toggleCompletion(dateStr) {
          if (this.isCompletedOn(dateStr)) {
            this.unmarkCompleted(dateStr);
          } else {
            this.markCompleted(dateStr);
          }
        }

        isCompletedOn(dateStr) {
          return this.history.includes(dateStr);
        }

        // Compute current streak (consecutive days up to today)
        getCurrentStreak() {
          const today = new Date();
          let streak = 0;
          let current = new Date(today);
          while (this.isCompletedOn(formatDate(current))) {
            streak++;
            current.setDate(current.getDate() - 1);
          }
          return streak;
        }

        // Compute longest streak from history
        getLongestStreak() {
          if (this.history.length === 0) return 0;
          // sort dates ascending
          const dates = [...this.history].sort();
          let longest = 1;
          let currentStreak = 1;
          for (let i = 1; i < dates.length; i++) {
            const prev = new Date(dates[i - 1]);
            const curr = new Date(dates[i]);
            const diff = (curr - prev) / (1000 * 60 * 60 * 24);
            if (diff === 1) {
              currentStreak++;
            } else {
              currentStreak = 1;
            }
            longest = Math.max(longest, currentStreak);
          }
          return longest;
        }
      }

      // HabitManager class to manage habit list and UI
      class HabitManager {
        constructor() {
          this.habits = [];
          this.LOCAL_STORAGE_KEY = "habitTrackerHabits";
          this.loadHabits();
          // Settings
          this.settings = {
            hideCompleted: JSON.parse(localStorage.getItem("hideCompletedHabits")) || false,
          };
          this.setupEventListeners();
          this.renderUI();
        }

        loadHabits() {
          try {
            const stored = JSON.parse(localStorage.getItem(this.LOCAL_STORAGE_KEY)) || [];
            this.habits = stored.map((data) => new Habit(data));
          } catch (e) {
            this.habits = [];
          }
        }

        saveHabits() {
          localStorage.setItem(this.LOCAL_STORAGE_KEY, JSON.stringify(this.habits));
        }

        renderUI() {
          this.renderHabitEntries();
          this.renderHeatmap();
        }

        renderHabitEntries() {
          const container = $("habit-entries");
          if (!container) return;
          if (this.habits.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-500 py-4">No habits added yet. Click the + button to add one!</p>`;
            return;
          }
          // Optionally hide habits that are "completed" (if user marks a habit as completed every day you might want to hide it)
          const filteredHabits = this.settings.hideCompleted
            ? this.habits.filter((habit) => !habit.isCompletedOn(formatDate(new Date())))
            : this.habits;
          container.innerHTML = filteredHabits
            .map((habit) => {
              const today = formatDate(new Date());
              const completedToday = habit.isCompletedOn(today);
              const currentStreak = habit.getCurrentStreak();
              const longestStreak = habit.getLongestStreak();
              return `
              <div class="habit-entry" data-id="${habit.id}">
                <div class="habit-header" onclick="habitManager.openEditHabitModal('${habit.id}')">
                  <div>
                    <h3 class="habit-title ${completedToday ? 'habit-completed' : ''}">${habit.name}</h3>
                    ${
                      habit.description
                        ? `<p class="text-sm text-gray-600">${habit.description}</p>`
                        : ""
                    }
                  </div>
                  <div class="flex flex-col items-end">
                    <button onclick="event.stopPropagation(); habitManager.toggleToday('${habit.id}')" class="mb-1 px-2 py-1 border rounded text-sm ${completedToday ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-800'}">
                      ${completedToday ? "Done" : "Mark Done"}
                    </button>
                    <div class="text-xs text-gray-700">
                      <span>Current: ${currentStreak}d</span> |
                      <span>Longest: ${longestStreak}d</span>
                    </div>
                  </div>
                </div>
              </div>
              `;
            })
            .join("");
        }

        renderHeatmap() {
          // Render a weekly heatmap for all habits
          const container = $("heatmap-container");
          if (!container) return;
          container.innerHTML = "";
          const today = new Date();
          // Get the last 7 days (oldest to newest)
          const dates = [];
          for (let i = 6; i >= 0; i--) {
            const d = new Date();
            d.setDate(today.getDate() - i);
            dates.push(formatDate(d));
          }

          // Header row with weekday abbreviations
          const headerRow = document.createElement("div");
          headerRow.className = "grid grid-cols-[150px_1fr] items-center mb-2";
          headerRow.innerHTML = `
            <div></div>
            <div class="grid grid-cols-7 gap-1 text-center text-sm font-medium text-gray-600">
              ${dates
                .map((d) => {
                  const dayName = new Date(d).toLocaleDateString(undefined, {
                    weekday: "short",
                  });
                  return `<div>${dayName}</div>`;
                })
                .join("")}
            </div>
          `;
          container.appendChild(headerRow);

          // For each habit, display a row with a label and 7 cells
          this.habits.forEach((habit) => {
            const row = document.createElement("div");
            row.className = "flex items-center mb-2";
            // Habit label
            const label = document.createElement("div");
            label.className =
              "w-36 text-sm font-medium text-gray-700 overflow-hidden text-ellipsis whitespace-nowrap";
            label.textContent = habit.name;
            row.appendChild(label);
            // Heatmap cells
            const cellsContainer = document.createElement("div");
            cellsContainer.className = "grid grid-cols-7 gap-1 flex-1";
            dates.forEach((d) => {
              const cell = document.createElement("div");
              cell.className = "heatmap-cell";
              // Color intensity: if habit was completed that day, full color; if not, light gray
              const isDone = habit.isCompletedOn(d);
              let bgColor;
              if (isDone) {
                bgColor =
                  habit.type === "good"
                    ? "bg-green-500"
                    : "bg-red-500";
              } else {
                bgColor = "bg-gray-200";
              }
              cell.classList.add(bgColor);
              cell.innerHTML = `<span class="text-xs text-white">${new Date(d).getDate()}</span>`;
              // Clicking on a cell toggles that day's completion
              cell.addEventListener("click", (e) => {
                e.stopPropagation();
                habit.toggleCompletion(d);
                this.saveHabits();
                this.renderUI();
              });
              cellsContainer.appendChild(cell);
            });
            row.appendChild(cellsContainer);
            container.appendChild(row);
          });
        }

        addHabit(data) {
          const newHabit = new Habit(data);
          this.habits.push(newHabit);
          this.saveHabits();
          this.renderUI();
        }

        updateHabit(updatedData) {
          const index = this.habits.findIndex((h) => h.id === updatedData.id);
          if (index > -1) {
            this.habits[index].name = updatedData.name;
            this.habits[index].description = updatedData.description;
            this.habits[index].type = updatedData.type;
            this.saveHabits();
            this.renderUI();
          }
        }

        deleteHabit(id) {
          this.habits = this.habits.filter((h) => h.id !== id);
          this.saveHabits();
          this.renderUI();
        }

        toggleToday(id) {
          const habit = this.habits.find((h) => h.id === id);
          if (!habit) return;
          const today = formatDate(new Date());
          habit.toggleCompletion(today);
          this.saveHabits();
          this.renderUI();
        }

        openAddHabitModal() {
          $("add-habit-modal").classList.remove("hidden");
          $("add-habit-form").reset();
        }

        closeAllModals() {
          document.querySelectorAll(".modal-close").forEach((btn) => {
            btn.closest("div[role='dialog'], .modal-close-btn").parentElement?.classList.add("hidden");
          });
          // Also close specific modals by ID
          $("add-habit-modal").classList.add("hidden");
          $("edit-habit-modal").classList.add("hidden");
          $("settings-modal").classList.add("hidden");
        }

        openEditHabitModal(id) {
          const habit = this.habits.find((h) => h.id === id);
          if (!habit) return;
          $("edit-habit-id").value = habit.id;
          $("edit-habit-name").value = habit.name;
          $("edit-habit-desc").value = habit.description;
          $("edit-habit-type").value = habit.type;
          $("edit-habit-modal").classList.remove("hidden");
        }

        setupEventListeners() {
          // Open add habit modal
          $("add-habit-btn").addEventListener("click", () => this.openAddHabitModal());
          // Close modals when clicking on .modal-close buttons
          document.querySelectorAll(".modal-close").forEach((btn) => {
            btn.addEventListener("click", () => this.closeAllModals());
          });
          // Add habit form submit
          $("add-habit-form").addEventListener("submit", (e) => {
            e.preventDefault();
            const data = {
              name: $("habit-name").value.trim(),
              description: $("habit-desc").value.trim(),
              type: $("habit-type").value,
            };
            if (data.name) {
              this.addHabit(data);
              this.closeAllModals();
            }
          });
          // Edit habit form submit
          $("edit-habit-form").addEventListener("submit", (e) => {
            e.preventDefault();
            const data = {
              id: $("edit-habit-id").value,
              name: $("edit-habit-name").value.trim(),
              description: $("edit-habit-desc").value.trim(),
              type: $("edit-habit-type").value,
            };
            if (data.name) {
              this.updateHabit(data);
              this.closeAllModals();
            }
          });
          // Delete habit button in edit modal
          $("delete-habit-btn").addEventListener("click", () => {
            const id = $("edit-habit-id").value;
            if (confirm("Are you sure you want to delete this habit?")) {
              this.deleteHabit(id);
              this.closeAllModals();
            }
          });
          // Settings button
          $("settings-btn").addEventListener("click", () => {
            $("settings-modal").classList.remove("hidden");
            $("hide-completed-habits").checked = this.settings.hideCompleted;
          });
          // Settings toggle change
          $("hide-completed-habits").addEventListener("change", (e) => {
            this.settings.hideCompleted = e.target.checked;
            localStorage.setItem("hideCompletedHabits", JSON.stringify(this.settings.hideCompleted));
            this.renderUI();
          });
          // Export data
          $("export-data").addEventListener("click", () => {
            const dataStr = JSON.stringify(this.habits);
            const dataUri = "data:application/json;charset=utf-8," + encodeURIComponent(dataStr);
            const link = document.createElement("a");
            link.setAttribute("href", dataUri);
            link.setAttribute("download", "habit_tracker_data.json");
            link.click();
          });
          // Import data
          $("import-data-btn").addEventListener("click", () => {
            $("import-data").click();
          });
          $("import-data").addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
              try {
                const imported = JSON.parse(evt.target.result);
                if (Array.isArray(imported)) {
                  if (confirm("This will replace your current data. Continue?")) {
                    this.habits = imported.map((data) => new Habit(data));
                    this.saveHabits();
                    this.renderUI();
                    alert("Data imported successfully!");
                  }
                } else {
                  throw new Error("Invalid format");
                }
              } catch (err) {
                alert("Error importing data. Please check the file.");
              }
            };
            reader.readAsText(file);
            e.target.value = "";
          });
        }
      }

      // Initialize the app
      let habitManager;
      document.addEventListener("DOMContentLoaded", () => {
        habitManager = new HabitManager();
      });
    </script>
  </body>
</html>
